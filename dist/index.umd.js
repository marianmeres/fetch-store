!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["fetch-store"]={})}(this,(function(e){"use strict";const t=e=>"function"==typeof e,r=(e,r="")=>{if(!t(e))throw new TypeError(`${r} Expecting function arg`.trim())},n=e=>t(e.subscribe),s=(e,n=null)=>{const s=e=>t(n?.persist)&&n.persist(e);let c=(()=>{const e=new Map,t=t=>(e.has(t)||e.set(t,new Set),e.get(t)),r=(e,r)=>{if("function"!=typeof r)throw new TypeError("Expecting callback function as second argument");return t(e).add(r),()=>t(e).delete(r)};return{publish:(e,r)=>{t(e).forEach((e=>e(r)))},subscribe:r,subscribeOnce:(e,t)=>{const n=r(e,(e=>{t(e),n()}));return n},unsubscribeAll:t=>e.delete(t)}})(),l=e;s(l);const a=()=>l,i=e=>{l!==e&&(l=e,s(l),c.publish("change",l))};return{set:i,get:a,update:e=>{r(e,"[update]"),i(e(a()))},subscribe:e=>(r(e,"[subscribe]"),e(l),c.subscribe("change",e))}},c={fetchOnceDefaultThresholdMs:3e5,isEqual:(e,t)=>e===t};e.createFetchStore=(e,l=null,a=null,i={})=>{const{fetchOnceDefaultThresholdMs:u,isEqual:o}={...c,...i||{}},h=(e,t)=>"function"==typeof a?a?.(e,t):e,g=s(h(l),i),f=s({isFetching:!1,lastFetchStart:null,lastFetchEnd:null,lastFetchError:null,lastFetchSilentError:null,successCounter:0,hasChangedSinceLastFetch:!1}),{subscribe:b,get:p}=((e,c,l=null)=>{const a=e=>t(l?.persist)&&l.persist(e),i=s(l?.initialValue),u=[];if(e.forEach((e=>{if(!n(e))throw new TypeError("Expecting array of StoreLike objects");e.subscribe((e=>u.push(e)))()})),!t(c))throw new TypeError("Expecting second argument to be the derivative function");if(!c.length||c.length>2)throw new TypeError("Expecting the derivative function to have exactly 1 or 2 arguments");let o=0,h=[];return{get:i.get,subscribe:t=>{r(t,"[derived.subscribe]"),o++||e.forEach(((e,t)=>{h.push(e.subscribe((e=>{u[t]=e,1===c.length?(i.set(c(u)),a(i.get())):c(u,(e=>{i.set(e),a(i.get())}))})))}));const n=i.subscribe(t);return()=>{--o||(h.forEach((e=>e())),h=[]),n()}}}})([g,f],(([e,t])=>({data:e,...t})));b((()=>null));let d=l;const E=e=>{let t;return"function"==typeof o&&(t=!o(d,e)),d=e,t},F=async(...t)=>{let r=f.get();r.isFetching=!0,r.lastFetchStart=new Date,r.lastFetchEnd=null,r.lastFetchError=null,f.set({...r});try{g.set(h(await e(...t),g.get())),r.successCounter++}catch(e){r.lastFetchError=e}finally{r.isFetching=!1,r.lastFetchEnd=new Date}return f.set({...r,hasChangedSinceLastFetch:E(g.get())}),f.get().lastFetchError?null:g.get()};let y=0;const w=(e=[],t=500)=>{const{isFetching:r}=f.get();Array.isArray(e)||(e=[e]),-1===y&&(y=0);const n=()=>{y>0&&clearTimeout(y),y=setTimeout((()=>{-1!==y&&w.apply(null,[e,t])}),t)};return r?n():F(...e).then(n),()=>{y?clearTimeout(y):y=-1}},S={subscribe:b,get:p,fetch:F,fetchSilent:async(...t)=>{let r=f.get();r.lastFetchSilentError&&f.set({...r,lastFetchSilentError:null});try{g.set(h(await e(...t),g.get()))}catch(e){r.lastFetchSilentError=e}return f.set({...r,hasChangedSinceLastFetch:E(g.get())}),f.get().lastFetchSilentError?null:g.get()},fetchOnce:async(e=[],t=u)=>{const{successCounter:r,isFetching:n,lastFetchStart:s}=f.get();return Array.isArray(e)||(e=[e]),r||n?t&&!n&&s&&Date.now()-new Date(s).valueOf()>t?await F(...e):g.get():await F(...e)},fetchRecursive:w,reset:()=>{g.set(h(l)),f.set({isFetching:!1,lastFetchStart:null,lastFetchEnd:null,lastFetchError:null,lastFetchSilentError:null,successCounter:0,hasChangedSinceLastFetch:!1})},resetError:()=>f.update((e=>({...e,lastFetchError:null}))),getInternalDataStore:()=>g,fetchWorker:e};return S}}));
